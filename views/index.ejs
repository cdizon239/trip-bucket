<div class="sidebar-view">
    <div>
        <h3>Your trips:</h3>
        <%if (userId) {%>
            <a href="/trips/new" class="btn btn-primary">Plan a new trip</a>
            <% let tripsList = JSON.parse(trips) %>
            <% tripsList =  tripsList.sort((a,b) => new Date(b.start_date) - new Date(a.start_date)) %>
            <% let groupTripsByYear = tripsList.reduce((newData, trip) => { %>
                <% let key = trip.start_date ? new Date(trip['start_date']).getFullYear() : 'Unscheduled' %>
                <% if(!newData[key]) { %> 
                    <% newData[key] = [] %>
                <% } %> 
                <% newData[key].push(trip) %>
                <% return newData %> 
            <% }, {}) %> 
            <% for (year in groupTripsByYear) {%>
                <h4><%= year%></h4>
                <%(groupTripsByYear[year]).forEach((trip) => { %>
                    <a  class="btn" href="/trips/<%= trip._id %>">
                        <%= trip.name %>
                    </a>
                <% }) %>

            <% } %>
        <% } %>
            
            
   
    </div>
    <div id='map' style='width: 100%; height: 100vh;'>
    </div>
</div>

<!-- CLIENT SIDE -->
<script>
    // access the places in the database
    let trips= JSON.parse('<%- trips %>')

    //  make the map
    mapboxgl.accessToken  = '<%= process.env.MAPBOX_ACCESS_TOKEN %>'
    const map = new mapboxgl.Map({
    container: 'map', // container ID
    style: 'mapbox://styles/mapbox/streets-v11', // style URL
    zoom: 1// starting zoom
    });

    //  add markers fro mthe database
    trips.forEach((trip) => {
        if (trip.places_to_visit.length > 0) {
            trip.places_to_visit.forEach((pin) => {
                let marker = new mapboxgl.Marker({
                    color: "#F05441"
                }).setLngLat([pin.long, pin.lat])
                .setPopup(new mapboxgl.Popup().setHTML(`<h4>${pin.title}</h4>`)) 
                .addTo(map);
            })
        }
    })
    // Add zoom and rotation controls to the map.
    const nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');
    // Add searchbox via geocoding api: src: https://docs.mapbox.com/help/tutorials/local-search-geocoding-api/
    const geocoder = new MapboxGeocoder({
        // Initialize the geocoder
        accessToken: mapboxgl.accessToken, // Set the access token
        mapboxgl: mapboxgl, // Set the mapbox-gl instance
    });
    // Add the geocoder to the map
    map.addControl(geocoder);
    //  log data of search results
    geocoder.on('result', (data) => {
        let placeToVisit = {
            lat: (data.result.geometry.coordinates)[1],
            long: (data.result.geometry.coordinates)[0],
            title: data.result.text,
        }
    });
    
    // let start, end, duration
    // let clickThreshold = 400
    // let marker

    // map.on('mousedown', (event) => {
    //     start = Date.now()
    //     marker.remove()
    // })

    // map.on('mouseup', (event) => {
    //         end = Date.now()
    //         duration = (end - start) + 1
    //         if (duration > clickThreshold) {
    //             marker = new mapboxgl.Marker().setLngLat([event.lngLat.lng, event.lngLat.lat]).addTo(map)
    //         }
    //     })

</script>